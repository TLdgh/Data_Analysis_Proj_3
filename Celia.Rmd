```{r}
read.csv("BASA_AUC_2028_912.csv")
read.csv("dat_F_sub.csv")
read.csv("dat_P_sub_c.csv")
read.csv("years20262030.csv")
```

```{r}
#合并三张表格中相同的列
file_names <- c("BASA_AUC_2028_912.csv", "dat_P_sub_c.csv", "years20262030.csv")
data_frames <- list()

for (file_name in file_names) {
  data <- read.csv(file_name, header = TRUE, stringsAsFactors = FALSE)
  data_frames[[file_name]] <- data
}

common_column_names <- Reduce(intersect, lapply(data_frames, colnames))

merged_data <- data.frame()
for (file_name in file_names) {
  common_data <- data_frames[[file_name]][, common_column_names, drop = FALSE]
  merged_data <- merge(merged_data, common_data, all = TRUE)
}

print(merged_data)
```

```{r}
#按照S2的时间给表格重新排序
merged_data$S2 <- as.POSIXct(merged_data$S2, format = "%Y/%m/%d %H:%M")
merged_data$Sch_Departure <- as.POSIXct(merged_data$Sch_Departure, format="%Y/%m/%d %H:%M")

data2 <- merged_data[order(merged_data$S2), ]
head(data2)
```

```{r}
#把Wait_Time为NA的行删掉
data2 <- data2[complete.cases(data2$Wait_Time), ]

#计算Sch_Departure和S2的时间差值(提前过安检的时间)
time_difference_hours <- as.numeric(difftime(data2$Sch_Departure, data2$S2, units="hours"))
data2$Time_Difference <- time_difference_hours

#按照Airfield分类
air_data <- split(data2, data2$Airfield)

p <- plot_ly()

colors <- c("lightblue", "orange")

for (i in 1:length(air_data)) {
  current_data <- air_data[[i]]

  p <- add_trace(
    p,
    type = "histogram",
    x = ~Time_Difference,
    data = current_data,
    name = unique(current_data$Airfield),
    marker = list(color = colors[i]),
    opacity = 0.7
  )
}

p <- layout(
  p,
  title = "Histogram of Time Differences by Airfield",
  xaxis = list(title = "Time Difference", range = c(-5, 10)),
  yaxis = list(title = "Frequency"),
  barmode = "overlay"
)

p
```

```{r}
#根据Time_of_Day分类
time_of_day_categories <- unique(data2$Time_of_Day)

p0 <- plot_ly()
for (time_of_day in time_of_day_categories) {
  subset_data <- data2[data2$Time_of_Day == time_of_day, ]
  color <- switch(
    time_of_day,
    "2 - MORNING" = "lightblue",
    "3 - AFTERNOON" = "orange",
    "4 - EVENING" = "green",
    "1 - NIGHT" = "purple"
  )
  p0 <- add_trace(
    p0,
    type = "histogram",
    x = subset_data$Wait_Time,
    name = time_of_day,
    marker = list(color = color, line = list(color = "black")),
    xbins = list(size = 2)
  )
}

p0 <- layout(
  p0,
  title = "Wait Time by Time_of_Day",
  xaxis = list(title = "Wait Time(Minute)"),
  yaxis = list(title = "Frequency"),
  showlegend = TRUE
)

p0
```

```{r}
# 每个Time_of_Day的平均 Wait_Time
avg_time_day <- tapply(data2$Wait_Time, data2$Time_of_Day, mean)

avg_time_day_df <- data.frame(Time_of_Day = names(avg_time_day),
                               Average_Wait_Time = avg_time_day)

plot_ly(
  x = avg_time_day_df$Time_of_Day,
  y = avg_time_day_df$Average_Wait_Time,
  type = "bar",
  name = "Average Wait Time",
  marker = list(color = "lightblue", line = list(color = "black")),
              text = avg_time_day_df$Average_Wait_Time,
              textposition = "outside",
              textfont = list(size = 14)) %>%
  layout(
    title = "Average Wait Time by Time_of_Day",
    xaxis = list(title = "Time_of_Day"),
    yaxis = list(title = "Average Wait Time")
  )
```

```{r}
#根据Weekday还是Weekend分类
period_of_week_categories <- unique(data2$Period_of_Week)

p1 <- plot_ly()
for (period_of_week in period_of_week_categories) {
  subset_data <- data2[data2$Period_of_Week == period_of_week, ]

  color <- ifelse(period_of_week == "1 - WEEKDAY", "lightblue", "orange")

  p1 <- add_trace(
    p1,
    type = "histogram",
    x = subset_data$Wait_Time,
    name = period_of_week,
    marker = list(color = color, line = list(color = "black")),
    xbins = list(size = 2)
  )
}
p1 <- layout(
  p1,
  title = "Wait Time by Period_of_Week",
  xaxis = list(title = "Wait Time(Minute)"),
  yaxis = list(title = "Frequency"),
  showlegend = TRUE
)

p1
```

```{r}
# 每个 Period_of_Week 的平均 Wait_Time
avg_time_week <- tapply(data2$Wait_Time, data2$Period_of_Week, mean)

avg_time_week_df <- data.frame(Period_of_Week = names(avg_time_week),
                               Average_Wait_Time = avg_time_week)

plot_ly(
  x = avg_time_week_df$Period_of_Week,
  y = avg_time_week_df$Average_Wait_Time,
  type = "bar",
  name = "Average Wait Time",
  marker = list(color = "lightblue", line = list(color = "black")),
              text = avg_time_week_df$Average_Wait_Time,
              textposition = "outside",
              textfont = list(size = 14)) %>%
  layout(
    title = "Average Wait Time by Weekday and Weekend",
    xaxis = list(title = "Period_of_Week"),
    yaxis = list(title = "Average Wait Time")
  )
```

```{r}
#根据星期分类
day_of_week_categories <- unique(data2$Day_of_Week)

p2 <- plot_ly()
for (day_of_week in day_of_week_categories) {
  subset_data <- data2[data2$Day_of_Week == day_of_week, ]
  
  color <- switch(
    day_of_week,
    "1 - MON" = "lightblue",
    "2 - TUE" = "orange",
    "3 - WED" = "green",
    "4 - THU" = "red",
    "5 - FRI" = "purple",
    "6 - SAT" = "brown",
    "7 - SUN" = "pink"
  )

  p2 <- add_trace(
    p2,
    type = "histogram",
    x = subset_data$Wait_Time,
    name = day_of_week,
    marker = list(color = color, line = list(color = "black")),
    xbins = list(size = 2)
  )
}

p2 <- layout(
  p2,
  title = "Wait Time by Day_of_Week",
  xaxis = list(title = "Wait Time(Minute)", range = c(0, 20)),
  yaxis = list(title = "Frequency"),
  showlegend = TRUE
)

p2
```

```{r}
# 每个 Day_of_Week 的平均 Wait_Time
avg_time <- tapply(data2$Wait_Time, data2$Day_of_Week, mean)

avg_time_df <- data.frame(Day_of_Week = names(avg_time),
                               Average_Wait_Time = avg_time)

plot_ly(x = avg_time_df$Day_of_Week,
              y = avg_time_df$Average_Wait_Time,
              type = "bar",
              name = "Average Wait Time",
              marker = list(color = "lightblue", line = list(color = "black")),
              text = avg_time_df$Average_Wait_Time,
              textposition = "outside",
              textfont = list(size = 14)) %>%
  layout(title = "Average Wait Time by Day of Week",
         xaxis = list(title = "Day of Week"),
         yaxis = list(title = "Average Wait Time"))
```

```{r}
#一天内不同时间段通过S2人数的表格
hour <- as.numeric(format(as.POSIXct(data2$S2, format="%Y-%m-%d %H:%M:%S"), "%H"))
count_hour <- table(factor(cut(hour, breaks = c(0, 3, 7, 11, 15, 19, 23), labels = FALSE, include.lowest = TRUE),levels = 1:6))
p <- plot_ly(x = c("0-3", "4-7", "8-11", "12-15", "16-19", "20-23"),
        y = count_hour,
        type = "bar",
        name = "Count",
        marker = list(color = "skyblue", line = list(color = "black"))) %>%
  layout(title = "Distribution of Data Across Time Slots",
         xaxis = list(title = "Time Slot"),
         yaxis = list(title = "Count"))
plot_ly(x = c("0-3", "4-7", "8-11", "12-15", "16-19", "20-23"),
             y = count_hour,
             type = "bar",
             name = "Count",
             marker = list(color = "skyblue", line = list(color = "black")),
             text = count_hour,
             textposition = "outside",
             textfont = list(size = 14)) %>%
  layout(title = "Number of Passengers Scaned at S2 at Different Period of the Day",
         xaxis = list(title = "Different Period of the Day"),
         yaxis = list(title = "Number of Passengers"))
```